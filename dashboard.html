<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Hackathon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar and aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
        }

        .pitch-card {
            background-color: #ffffff;
            border-left: 5px solid #8dceb8;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .pitch-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        /* Custom Button Styling */
        #generate-button {
            background-color: rgb(20, 167, 20);
            transition: all 0.15s ease;
            box-shadow: 0 4px 6px -1px rgba(90, 93, 92, 0.3), 0 2px 4px -1px rgba(62, 93, 83, 0.1);
        }

        #generate-button:hover {
            background-color: #617d74;
            transform: translateY(-1px);
        }

        #generate-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        /* Styling for the output area */
        #pitch-output pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #f0fdf4;
            border: 1px solid #d1fae5;
        }

        /* --- START Dashboard Custom Styles (Aapke code se liye gaye) --- */
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #66a993;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 auto 1rem;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ebefee;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- END Dashboard Custom Styles --- */
    </style>
</head>

<body class="p-4 sm:p-8">

    <header class="text-center mb-10">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800 tracking-tight">PitchCraft <span
                class="text-emerald-700">AI</span></h1>
        <p class="mt-2 text-xl text-gray-600">
            AI-Powered Startup Pitch Generator
            <!-- <span class="block text-sm font-light text-gray-500 mt-1">
                (AI Se Chalne Wala Startup Pitch Banane Wala App)
            </span> -->
        </p>
    </header>

    <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Input & Generation Form (Column 1) -->
        <div class="lg:col-span-2 bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-3">Generate Your Pitch</h2>
            <form id="pitch-form" class="space-y-4">
                <!-- Startup Name -->
                <div>
                    <label for="startup-name" class="block text-sm font-medium text-gray-700">Startup Name</label>
                    <input type="text" id="startup-name" required placeholder="Health Mate"
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <!-- Problem -->
                <div>
                    <label for="problem" class="block text-sm font-medium text-gray-700">The Problem</label>
                    <textarea id="problem" rows="3" required
                        placeholder="Enter Your Problem."
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>
                <!-- Solution -->
                <div>
                    <label for="solution" class="block text-sm font-medium text-gray-700">The Solution/Product</label>
                    <textarea id="solution" rows="3" required
                        placeholder="Enter Your Solution"
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

                <!-- Call to Action -->
                <button type="submit" id="generate-button"
                    class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-emerald-500 hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150 ease-in-out">
                    Generate Pitch
                </button>
            </form>

            <!-- Loading & Output Area -->
            <div id="loading"
                class="mt-6 hidden text-center p-4 bg-yellow-100 rounded-lg text-yellow-700 font-semibold animate-pulse">
                Generating Pitch... Please wait.
            </div>

            <div id="pitch-output" class="mt-8">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Generated Pitch</h3>
                <div id="output-text" class="text-gray-800 text-lg">
                    <!-- AI generated pitch will appear here -->
                    <p class="text-gray-500 italic">Enter your details and click "Generate Pitch" to see the magic!</p>
                </div>
                <div id="citation-sources" class="mt-4 text-sm text-gray-500"></div>
            </div>
        </div>

        <!-- Pitch History (Column 2) -->
        <div class="lg:col-span-1 space-y-6">

            <!-- User Status Panel (Integrated Dashboard) -->
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100">
                <div id="user-status-container" class="space-y-4">
                    <div class="loading text-center" id="dashboard-loading" style="display: block;">
                        <div class="spinner"></div>
                        <p class="mt-2 text-sm text-gray-500">Authenticating...</p>
                    </div> 

                    <div class="dashboard text-center" id="dashboard" style="display: none;">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <h2 class="text-2xl font-bold text-gray-800 welcome-message">Welcome, <span id="user-display"
                                class="text-emerald-600">PitchCrafter</span>!</h2>
                        <p class="text-sm text-gray-600">You are securely signed in.</p>
                        
                        <p class="text-sm text-gray-600"><strong>User ID:</strong> <span id="user-email"
                                class="font-mono text-xs break-all">[Loading ID...]</span></p>

                        <button
                            class="w-full mt-4 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out logout-btn"
                            id="logout-btn">
                            Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pitch History Panel -->
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-3">Pitch History</h2>

                <div id="pitch-history" class="space-y-4 max-h-[600px] overflow-y-auto">
                    <p id="loading-history" class="text-center text-gray-500">Loading history...</p>
                </div>
            </div>

            <!-- Custom Modal for Delete Confirmation -->
            <div id="delete-modal"
                class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-2xl">
                    <h3 class="text-xl font-bold text-red-600 mb-4">Confirm Deletion</h3>
                    <p class="mb-6 text-gray-700">Are you sure you want to delete this pitch?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-delete"
                            class="px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition">
                            Cancel 
                        </button>
                        <button id="confirm-delete"
                            class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 transition">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // ------------------------------------------------------------------------------------------------
        // PitchCraft Application Logic
        // Application Logic (App Ka Kaam)
        // ------------------------------------------------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, setDoc, deleteDoc, serverTimestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Variables (Canvas se milne wale zaruri variables)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pitchcraft-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        const form = document.getElementById('pitch-form');
        const generateButton = document.getElementById('generate-button');
        const loadingDiv = document.getElementById('loading');
        const outputTextDiv = document.getElementById('output-text');
        const historyDiv = document.getElementById('pitch-history');
        const loadingHistoryP = document.getElementById('loading-history');
        const citationSourcesDiv = document.getElementById('citation-sources');

        // --- NEW DASHBOARD ELEMENTS (Naye Dashboard Elements) ---
        const dashboardDiv = document.getElementById('dashboard');
        const dashboardLoadingDiv = document.getElementById('dashboard-loading');
        const userAvatarSpan = document.getElementById('user-avatar');
        const userDisplaySpan = document.getElementById('user-display');
        const userEmailSpan = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-btn');
        // --- END NEW DASHBOARD ELEMENTS ---

        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete');
        const cancelDeleteButton = document.getElementById('cancel-delete');

        // --- Firebase Initialization and Authentication --- (Firebase Shuruat aur Tasdeeq)
        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up Authentication Listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;

                        // Show User Details (User ki Tafseelat Dikhana)
                        userDisplaySpan.textContent = 'PitchCrafter';
                        userAvatarSpan.textContent = userId.charAt(0).toUpperCase();
                        userEmailSpan.textContent = userId;

                        // Toggle UI visibility
                        dashboardLoadingDiv.style.display = 'none';
                        dashboardDiv.style.display = 'block';

                        setupPitchHistoryListener(); // Start listening for history once authenticated
                    } else {
                        // Attempt to sign in with custom token or anonymously
                        dashboardDiv.style.display = 'none';
                        dashboardLoadingDiv.style.display = 'block';

                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                            // userId will be set by the 'user' block above upon successful sign-in
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error (Firebase Shuruat Ka Masla):", error);
                dashboardDiv.textContent = `ERROR: Firebase failed to initialize. (Firebase shuru karne mein masla hua.)`;
            }
        }

        // --- Logout Functionality --- (Logout Ka Kaam)
        logoutButton.addEventListener('click', async () => {
            try {
                // Sign out the user
                await signOut(auth);
                // onAuthStateChanged will handle the UI update and attempt to sign in anonymously again
                console.log("User signed out successfully. Re-authenticating anonymously for continuity.");
            } catch (error) {
                console.error("Logout Error (Logout Mein Masla):", error);
                // Optionally show a user-facing error message
            }
        });

        // --- Firestore History Management --- (Firestore Tarikh Ka Intezaam)
        function getPitchCollectionRef(uid) {
            // Private data storage: /artifacts/{appId}/users/{userId}/pitches
            return collection(db, 'artifacts', appId, 'users', uid, 'pitches');
        }

        function setupPitchHistoryListener() {
            if (!userId) {
                console.error("Cannot set up listener: User ID is missing.");
                return;
            }

            const pitchesRef = getPitchCollectionRef(userId);
            const q = query(pitchesRef);

            // Real-time listener for pitches
            onSnapshot(q, (snapshot) => {
                const pitches = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Deserialize the text content if it was stored as JSON string (best practice for complex text)
                    try {
                        data.pitchText = data.pitchText ? JSON.parse(data.pitchText) : 'No content';
                    } catch {
                        // If it's not JSON, assume it's plain text (fallback)
                    }

                    pitches.push({ id: doc.id, ...data });
                });

                // Sort by creation time, latest first
                pitches.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                renderPitchHistory(pitches);
            }, (error) => {
                console.error("Error listening to pitches (Pitches sunne mein masla):", error);
                historyDiv.innerHTML = `<p class="text-red-500">Error loading history: ${error.message}</p>`;
            });
        }

        function renderPitchHistory(pitches) {
            historyDiv.innerHTML = ''; // Clear existing content
            loadingHistoryP.classList.add('hidden'); // Hide loading indicator

            if (pitches.length === 0) {
                historyDiv.innerHTML = `<p class="text-center text-gray-500 italic p-4">No pitches saved yet. (Abhi tak koi pitch save nahi ki gayi.)</p>`;
                return;
            }

            pitches.forEach(pitch => {
                const pitchCard = document.createElement('div');
                pitchCard.className = 'pitch-card p-4 rounded-lg border border-gray-200';

                const date = pitch.createdAt ? new Date(pitch.createdAt.toDate()).toLocaleDateString() : 'N/A';

                pitchCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-md font-semibold text-gray-800">${pitch.startupName || 'Untitled Pitch'}</h4>
                        <button data-id="${pitch.id}" class="delete-pitch text-red-500 hover:text-red-700 transition" title="Delete Pitch (Pitch Hataein)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 truncate">${pitch.problem || 'No Problem Defined'}</p>
                    <p class="text-xs text-gray-400 mt-1">Date: ${date}</p>
                `;
                historyDiv.appendChild(pitchCard);
            });

            // Attach delete listeners
            historyDiv.querySelectorAll('.delete-pitch').forEach(button => {
                button.addEventListener('click', (e) => {
                    const pitchIdToDelete = e.currentTarget.dataset.id;
                    openDeleteModal(pitchIdToDelete);
                });
            });
        }

        function openDeleteModal(pitchId) {
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
            // Set up handlers for the modal
            confirmDeleteButton.onclick = () => deletePitch(pitchId);
            cancelDeleteButton.onclick = closeDeleteModal;
        }

        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
        }

        async function deletePitch(pitchId) {
            closeDeleteModal();
            if (!userId) {
                console.error("Cannot delete pitch: User not authenticated.");
                return;
            }
            try {
                const pitchRef = doc(getPitchCollectionRef(userId), pitchId);
                await deleteDoc(pitchRef);
                console.log("Pitch deleted successfully:", pitchId);
            } catch (error) {
                console.error("Error deleting pitch (Pitch hataane mein masla):", error);
                // Optionally show an error message to the user
            }
        }

        async function savePitch(startupName, problem, solution, pitchText) {
            if (!userId) {
                console.error("Cannot save pitch: User not authenticated.");
                return;
            }
            try {
                // Generate a unique ID for the document first
                const newDocRef = doc(getPitchCollectionRef(userId));

                // Serialize the generated text to a JSON string before saving (best practice)
                const textToSave = JSON.stringify(pitchText);

                await setDoc(newDocRef, {
                    startupName,
                    problem,
                    solution,
                    pitchText: textToSave,
                    createdAt: serverTimestamp(),
                    userId: userId // Optional: helpful for security rules and debugging
                });
                console.log("Pitch saved successfully (Pitch Mehfooz ho gaya):", newDocRef.id);
            } catch (error) {
                console.error("Error saving pitch (Pitch save karne mein masla):", error);
            }
        }

        // --- Gemini API Logic --- (Gemini API Ka Kaam)

        const systemPrompt = `You are PitchCraft, an elite startup pitch ghostwriter and investor expert. Your task is to generate a compelling, concise, and structured elevator pitch (around 200-300 words) based on the user's input (Startup Name, Problem, Solution).
        The pitch MUST follow this structure:
        1. **HOOK:** A short, attention-grabbing opening.
        2. **PROBLEM:** Clearly state the user's defined problem and its scope.
        3. **SOLUTION:** Introduce the startup's name and its unique solution/product.
        4. **TRACTION/MARKET (Inferred):** Briefly mention market potential, competitive advantage, or early success (even if inferred or generic).
        5. **ASK/CONCLUSION:** A strong closing statement inviting the listener to the next step.
        Format the output using Markdown with bold headings for clarity. Do not include any conversational filler outside of the structured pitch.`;

        async function generatePitch(startupName, problem, solution) {
            const userQuery = `
            Please generate the startup pitch using the following details:
            Startup Name: ${startupName}
            The Problem: ${problem}
            The Solution: ${solution}
            `;

            const apiKey = "AIzaSyCR8eN3ETLnYz-_H72VdT_oCrxcrPufHB4"; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Use Google Search grounding for real-time context and market trends
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 3;
            let attempt = 0;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // If response is not OK, throw error to trigger retry logic
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];

                        // Extract grounding sources
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        return { text, sources };
                    } else {
                        // Handle cases where model failed to generate text
                        throw new Error("Model response was empty or malformed.");
                    }

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error.message);
                    attempt++;
                    if (attempt < maxRetries) {
                        // Exponential backoff
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Final failure
                        throw new Error("Failed to generate pitch after multiple retries. (Kai baar koshish ke baad bhi pitch nahi ban saka.)");
                    }
                }
            }
        }

        // --- Event Listener and Main Handler --- (Event Sunne Wala aur Asli Kaam Karne Wala)

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Input Validation
            const startupName = document.getElementById('startup-name').value.trim();
            const problem = document.getElementById('problem').value.trim();
            const solution = document.getElementById('solution').value.trim();

            if (!startupName || !problem || !solution) {
                outputTextDiv.innerHTML = '<p class="text-red-500 font-semibold">Please fill in all fields. (Kirpya sabhi khali jaghein bhar dein.)</p>';
                return;
            }

            loadingDiv.classList.remove('hidden');
            generateButton.disabled = true;
            outputTextDiv.innerHTML = '';
            citationSourcesDiv.innerHTML = '';

            try {
                const result = await generatePitch(startupName, problem, solution);

                // 1. Display the Pitch (Pitch Dikhana)
                // Use <pre> to maintain formatting like line breaks from Markdown output
                outputTextDiv.innerHTML = `<pre>${result.text}</pre>`;

                // 2. Display Citations (Hawale Dikhana)
                if (result.sources && result.sources.length > 0) {
                    const uniqueSources = Array.from(new Map(result.sources.map(item => [item.uri, item])).values());
                    citationSourcesDiv.innerHTML = '<h4 class="text-md font-semibold mt-4">Sources (Hawale):</h4><ul class="list-disc ml-5 mt-2 space-y-1">';
                    uniqueSources.forEach((source, index) => {
                        citationSourcesDiv.innerHTML += `<li><a href="${source.uri}" target="_blank" class="text-blue-500 hover:text-blue-700">${source.title}</a></li>`;
                    });
                    citationSourcesDiv.innerHTML += '</ul>';
                }

                // 3. Save the Pitch to Firestore (Pitch ko Mehfooz Karna)
                await savePitch(startupName, problem, solution, result.text);

            } catch (error) {
                console.error("Generation Error (Pitch Banane Mein Masla):", error);
                outputTextDiv.innerHTML = `<p class="text-red-500 font-semibold">Error: ${error.message}</p>`;
            } finally {
                loadingDiv.classList.add('hidden');
                generateButton.disabled = false;
            }
        });

        // Start the application
        initializeFirebase();
    </script>
</body>

</html>